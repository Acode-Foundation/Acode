name: On Demand Preview Releases for PR
#  avoids paths like .md, and anything in .github folder
on:
  pull_request:
    paths-ignore:
      - '!*.md'
#      - '.github/**'
    types: [labeled, synchronize]


permissions:
  contents: write
  pull-requests: write
  # All Pull Requests are issues, but not all issues are Pull Requests (like GitHub says üôÉ)
  issues: write

concurrency:
  # Allow only one workflow per any non-`main` branch.
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.ref_name == 'main' && github.sha || 'anysha' }}
  cancel-in-progress: true

jobs:
  job_trigger:
    name: Trigger Preview Release (if conditions met)
    if: |
      (!contains(github.event.pull_request.labels.*.name, 'DO NOT PREVIEW RELEASE') 
      && (contains(github.event.pull_request.labels.*.name, 'Bypass check - PREVIEW RELEASE') 
      || contains(github.event.pull_request.labels.*.name, 'CI: RUN ON-DEMAND PREVIEW RELEASES')))

    runs-on: ubuntu-latest
    # if: github.repository_owner == 'Acode-Foundation'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: '1'

      - name: Remove Manually added PR Label
        if: |
          contains(github.event.pull_request.labels.*.name, 'CI: RUN ON-DEMAND PREVIEW RELEASES')

        run: gh pr edit $PR --remove-label "$labels"
        env:
           PR: ${{ github.event.pull_request.number }}
           labels: 'CI: RUN ON-DEMAND PREVIEW RELEASES'
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add comment to PR
        run: |
            gh pr comment $PR --body "‚öíÔ∏è Starting a workflow to build, Your On-Demand Preview Release/build for ${{ github.event.pull_request.url }}. \n\n status: **`üü° in_progress`** \n\n Kindly wait, this message will be updated with success or failure status."
        env:
          PR: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Nightly Release Builder Workflow
        id: nightly_release_builder
        uses: ./.github/workflows/nightly-build.yml@ci/nightly-builds
        with:
          is_PR: true
          PR_NUMBER: ${{ github.event.pull_request.number }}

        continue-on-error: true

      - name: Update Last Comment by bot (if Workflow Triggering failed)
        if: failure()
        run: |
          gh pr comment --edit-last $PR --body "üî¥ (Workflow Trigger failure), Your On-Demand Preview Release/build for ${{ github.event.pull_request.url}}. \n\n status: **`üî¥ failed`** \n For Owners: Please check the workflow at https://${{ github.server_url }}/${{ github.repository}}/actions"
        env:
          PR: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}