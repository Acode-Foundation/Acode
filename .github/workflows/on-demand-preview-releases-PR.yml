name: On Demand Preview Releases for PR
#  avoids paths like .md, and anything in .github folder
on:
  pull_request:
    paths-ignore:
      - '!*.md'
#      - '.github/**'
    types: [labeled, synchronize]


permissions:
  contents: write
  pull-requests: write
  # All Pull Requests are issues, but not all issues are Pull Requests (like GitHub says üôÉ)
  issues: write

concurrency:
  # Allow only one workflow per any non-`main` branch.
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.ref_name == 'main' && github.sha || 'anysha' }}
  cancel-in-progress: true

jobs:
  job_trigger:
    name: Trigger Preview Release (if conditions met)
    if: |
      (!contains(github.event.pull_request.labels.*.name, 'DO NOT PREVIEW RELEASE') 
      && (contains(github.event.pull_request.labels.*.name, 'Bypass check - PREVIEW RELEASE') 
      || contains(github.event.pull_request.labels.*.name, 'CI: RUN ON-DEMAND PREVIEW RELEASES')))

    runs-on: ubuntu-latest
    # if: github.repository_owner == 'Acode-Foundation'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
          fetch-depth: 0

      - name: Remove Manually added PR Label
        if: |
          contains(github.event.pull_request.labels.*.name, 'CI: RUN ON-DEMAND PREVIEW RELEASES')

        run: gh pr edit $PR --remove-label "$labels"
        env:
           PR: ${{ github.event.pull_request.number }}
           labels: 'CI: RUN ON-DEMAND PREVIEW RELEASES'
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add comment to PR
        run: |
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'github-actions@github.com'
            gh pr comment $PR --body "‚öíÔ∏è Starting a workflow to build, Your On-Demand Preview Release/build for ${{ github.event.pull_request.url }}. \n\n status: **\`üü° in_progress\`** \n\n Kindly wait, this message may be updated with success or failure status."
        env:
          PR: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trigger_builder:
      needs: job_trigger
      secrets: inherit
      uses: unschooledgamer/acode/.github/workflows/nightly-build.yml@256bf1a99d31f5948811dc9eb01de71b7e9d5072
      with:
        is_PR: true
        PR_NUMBER: ${{ github.event.pull_request.number }}
        skip_tagging_and_releases: true

  update_Last_Comment:
      needs: [job_trigger,trigger_builder]
      runs-on: ubuntu-latest
      if: ${{ needs.trigger_builder.result }}
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            clean: false
            fetch-depth: 0

        - name: Update Last Comment by bot (if Workflow Triggering failed)

          run: |
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'github-actions@github.com'
            gh pr comment --edit-last $PR --body "üî¥ (Workflow Trigger failure), Your On-Demand Preview Release/build for ${{ github.event.pull_request.url}}. \n\n status: **\`üî¥ failed\`** \n For Owners: Please check the workflow at https://${{ github.server_url }}/${{ github.repository}}/actions"
          env:
            PR: ${{ github.event.pull_request.number }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}